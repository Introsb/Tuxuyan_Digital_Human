<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASRå‰ç«¯åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .record-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .record-btn:hover {
            background: #0056b3;
        }
        .record-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .recording {
            background: #dc3545 !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .result-area {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            min-height: 100px;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ ASRè¯­éŸ³è¯†åˆ«åŠŸèƒ½æµ‹è¯•</h1>
            <p>æµ‹è¯•æ¶‚åºå½¦æ•™æˆæ•°å­—äººé¡¹ç›®çš„è¯­éŸ³è¯†åˆ«åŠŸèƒ½</p>
        </div>

        <!-- åç«¯çŠ¶æ€æ£€æŸ¥ -->
        <div class="test-section">
            <h3>ğŸ“¡ åç«¯æœåŠ¡çŠ¶æ€</h3>
            <button onclick="checkBackendStatus()" class="record-btn">æ£€æŸ¥åç«¯çŠ¶æ€</button>
            <div id="backend-status" class="result-area">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€...</div>
        </div>

        <!-- ASRåŠŸèƒ½æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ¤ è¯­éŸ³è¯†åˆ«æµ‹è¯•</h3>
            <button id="record-btn" onclick="toggleRecording()" class="record-btn">å¼€å§‹å½•éŸ³</button>
            <button onclick="clearResults()" class="record-btn">æ¸…é™¤ç»“æœ</button>
            
            <div class="status info">
                <strong>ä½¿ç”¨è¯´æ˜:</strong>
                <ol>
                    <li>ç‚¹å‡»"å¼€å§‹å½•éŸ³"æŒ‰é’®</li>
                    <li>å¯¹ç€éº¦å…‹é£è¯´è¯ï¼ˆ3-10ç§’ï¼‰</li>
                    <li>å†æ¬¡ç‚¹å‡»æŒ‰é’®åœæ­¢å½•éŸ³</li>
                    <li>ç­‰å¾…è¯­éŸ³è¯†åˆ«ç»“æœ</li>
                </ol>
            </div>

            <div id="recording-status" class="result-area">ç­‰å¾…å½•éŸ³...</div>
            <div id="asr-result" class="result-area">è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>

        <!-- æ¨¡æ‹Ÿè¾“å…¥æ¡†æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ“ æ–‡æœ¬å¡«å…¥æµ‹è¯•</h3>
            <textarea id="text-input" placeholder="è¯­éŸ³è¯†åˆ«çš„æ–‡æœ¬å°†è‡ªåŠ¨å¡«å…¥è¿™é‡Œ..." 
                      style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
            <div id="log-area" class="log-area">æµ‹è¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>
    </div>

    <script>
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        // æ£€æŸ¥åç«¯çŠ¶æ€
        async function checkBackendStatus() {
            const statusDiv = document.getElementById('backend-status');
            statusDiv.innerHTML = 'æ£€æŸ¥ä¸­...';
            
            try {
                log('ğŸ” æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€...');
                
                // æ£€æŸ¥åŸºæœ¬è¿æ¥
                const healthResponse = await fetch('http://127.0.0.1:8000/');
                if (!healthResponse.ok) {
                    throw new Error(`åç«¯æœåŠ¡ä¸å¯ç”¨: ${healthResponse.status}`);
                }
                
                const healthData = await healthResponse.json();
                log(`âœ… åç«¯æœåŠ¡æ­£å¸¸: v${healthData.version}`);
                
                // æ£€æŸ¥è¯­éŸ³æœåŠ¡çŠ¶æ€
                const speechResponse = await fetch('http://127.0.0.1:8000/speech_status');
                if (!speechResponse.ok) {
                    throw new Error(`è¯­éŸ³æœåŠ¡æ£€æŸ¥å¤±è´¥: ${speechResponse.status}`);
                }
                
                const speechData = await speechResponse.json();
                log(`ğŸ¤ ASRçŠ¶æ€: ${speechData.asr_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                
                statusDiv.innerHTML = `
                    <div class="status success">
                        <strong>âœ… åç«¯æœåŠ¡æ­£å¸¸</strong><br>
                        ç‰ˆæœ¬: ${healthData.version}<br>
                        åŠŸèƒ½: ${healthData.features.join(', ')}<br>
                        ASRå¯ç”¨: ${speechData.asr_enabled ? 'æ˜¯' : 'å¦'}<br>
                        ç™¾åº¦è¯­éŸ³: ${speechData.baidu_speech_available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}
                    </div>
                `;
                
            } catch (error) {
                log(`âŒ åç«¯çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`);
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>âŒ åç«¯æœåŠ¡å¼‚å¸¸</strong><br>
                        é”™è¯¯: ${error.message}
                    </div>
                `;
            }
        }

        // åˆ‡æ¢å½•éŸ³çŠ¶æ€
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                log('ğŸ¤ è¯·æ±‚éº¦å…‹é£æƒé™...');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                log('âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸ');
                
                // æ£€æµ‹æ”¯æŒçš„MIMEç±»å‹
                const mimeType = MediaRecorder.isTypeSupported('audio/wav') 
                    ? 'audio/wav' 
                    : MediaRecorder.isTypeSupported('audio/webm') 
                    ? 'audio/webm' 
                    : 'audio/ogg';
                
                log(`ğŸµ ä½¿ç”¨éŸ³é¢‘æ ¼å¼: ${mimeType}`);
                
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    log(`ğŸµ å½•éŸ³å®Œæˆï¼Œå¤§å°: ${audioBlob.size} bytes`);
                    
                    // åœæ­¢æ‰€æœ‰è½¨é“
                    stream.getTracks().forEach(track => track.stop());
                    
                    // å‘é€åˆ°ASR
                    await sendToASR(audioBlob, mimeType);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // æ›´æ–°UI
                const recordBtn = document.getElementById('record-btn');
                recordBtn.textContent = 'åœæ­¢å½•éŸ³';
                recordBtn.classList.add('recording');
                
                document.getElementById('recording-status').innerHTML = `
                    <div class="status info">
                        <strong>ğŸ¤ æ­£åœ¨å½•éŸ³...</strong><br>
                        è¯·å¯¹ç€éº¦å…‹é£è¯´è¯ï¼Œå†æ¬¡ç‚¹å‡»æŒ‰é’®åœæ­¢å½•éŸ³
                    </div>
                `;
                
                log('ğŸ¤ å¼€å§‹å½•éŸ³...');
                
            } catch (error) {
                log(`âŒ å½•éŸ³å¯åŠ¨å¤±è´¥: ${error.message}`);
                document.getElementById('recording-status').innerHTML = `
                    <div class="status error">
                        <strong>âŒ å½•éŸ³å¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // æ›´æ–°UI
                const recordBtn = document.getElementById('record-btn');
                recordBtn.textContent = 'å¼€å§‹å½•éŸ³';
                recordBtn.classList.remove('recording');
                
                document.getElementById('recording-status').innerHTML = `
                    <div class="status info">
                        <strong>â³ å¤„ç†å½•éŸ³ä¸­...</strong><br>
                        æ­£åœ¨å‘é€åˆ°è¯­éŸ³è¯†åˆ«æœåŠ¡...
                    </div>
                `;
                
                log('â¹ï¸ åœæ­¢å½•éŸ³ï¼Œå¼€å§‹å¤„ç†...');
            }
        }

        // å‘é€åˆ°ASRæœåŠ¡
        async function sendToASR(audioBlob, mimeType) {
            try {
                log('ğŸ“¤ å‘é€éŸ³é¢‘åˆ°ASRæœåŠ¡...');
                
                const formData = new FormData();
                const fileName = mimeType.includes('wav') ? 'recording.wav' : 'recording.webm';
                formData.append('audio_file', audioBlob, fileName);
                
                const response = await fetch('http://127.0.0.1:8000/asr', {
                    method: 'POST',
                    body: formData,
                });
                
                if (!response.ok) {
                    throw new Error(`ASRæœåŠ¡é”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                log(`ğŸ“¥ ASRå“åº”: ${JSON.stringify(result)}`);
                
                // æ˜¾ç¤ºç»“æœ
                const resultDiv = document.getElementById('asr-result');
                const textInput = document.getElementById('text-input');
                
                if (result.success && result.text && result.text.trim()) {
                    log(`âœ… è¯†åˆ«æˆåŠŸ: ${result.text}`);
                    
                    resultDiv.innerHTML = `
                        <div class="status success">
                            <strong>âœ… è¯†åˆ«æˆåŠŸ</strong><br>
                            æ–‡æœ¬: ${result.text}<br>
                            ç½®ä¿¡åº¦: ${(result.confidence || 0).toFixed(2)}<br>
                            æ¶ˆæ¯: ${result.message}
                        </div>
                    `;
                    
                    // å¡«å…¥æ–‡æœ¬æ¡†
                    textInput.value = result.text.trim();
                    textInput.focus();
                    
                } else {
                    const errorMsg = result.message || 'æœªè¯†åˆ«åˆ°å†…å®¹';
                    log(`âš ï¸ è¯†åˆ«é—®é¢˜: ${errorMsg}`);
                    
                    resultDiv.innerHTML = `
                        <div class="status error">
                            <strong>âš ï¸ è¯†åˆ«å¤±è´¥</strong><br>
                            é”™è¯¯: ${errorMsg}
                        </div>
                    `;
                }
                
                document.getElementById('recording-status').innerHTML = `
                    <div class="status success">
                        <strong>âœ… å¤„ç†å®Œæˆ</strong><br>
                        å¯ä»¥å¼€å§‹æ–°çš„å½•éŸ³
                    </div>
                `;
                
            } catch (error) {
                log(`âŒ ASRå¤„ç†å¤±è´¥: ${error.message}`);
                
                document.getElementById('asr-result').innerHTML = `
                    <div class="status error">
                        <strong>âŒ è¯†åˆ«å¤±è´¥</strong><br>
                        é”™è¯¯: ${error.message}
                    </div>
                `;
                
                document.getElementById('recording-status').innerHTML = `
                    <div class="status error">
                        <strong>âŒ å¤„ç†å¤±è´¥</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            document.getElementById('asr-result').innerHTML = 'è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
            document.getElementById('recording-status').innerHTML = 'ç­‰å¾…å½•éŸ³...';
            document.getElementById('text-input').value = '';
            document.getElementById('log-area').innerHTML = 'æµ‹è¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...\n';
            log('ğŸ§¹ å·²æ¸…é™¤æ‰€æœ‰ç»“æœ');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥åç«¯çŠ¶æ€
        window.onload = function() {
            log('ğŸš€ ASRå‰ç«¯æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            checkBackendStatus();
        };
    </script>
</body>
</html>
